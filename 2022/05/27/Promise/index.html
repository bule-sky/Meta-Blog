
<!DOCTYPE html>
<html lang="en" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ES6中Promise的使用 - 影月博客</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="Shadowmon,"> 
    <meta name="description" content="前端博客,Promise在 JavaScript 的世界中，所有代码都是单线程执行的。为了使程序不阻塞执行有了异步（I&amp;#x2F;O操作、事件操作），但是异步也有其不好之处，例如：异步回调callback 回,"> 
    <meta name="author" content="shadowmon"> 
    <link rel="alternative" href="atom.xml" title="影月博客" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    
    
    
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="ES6中Promise的使用 - 影月博客"/>
    <meta name="twitter:description" content="前端博客,Promise在 JavaScript 的世界中，所有代码都是单线程执行的。为了使程序不阻塞执行有了异步（I&amp;#x2F;O操作、事件操作），但是异步也有其不好之处，例如：异步回调callback 回,"/>
    
    
    
    
    <meta property="og:site_name" content="影月博客"/>
    <meta property="og:type" content="object"/>
    <meta property="og:title" content="ES6中Promise的使用 - 影月博客"/>
    <meta property="og:description" content="前端博客,Promise在 JavaScript 的世界中，所有代码都是单线程执行的。为了使程序不阻塞执行有了异步（I&amp;#x2F;O操作、事件操作），但是异步也有其不好之处，例如：异步回调callback 回,"/>
    
<link rel="stylesheet" href="/css/diaspora.css">

    <script>window.searchDbPath = "/search.xml";</script>
<meta name="generator" content="Hexo 6.2.0"><link rel="stylesheet" href="/assets/css/APlayer.min.css" class="aplayer-style-marker">
<script src="/assets/js/APlayer.min.js" class="aplayer-script-marker"></script>
<script src="/assets/js/Meting.min.js" class="meting-script-marker"></script>
</head>

<body class="loading">
    <span id="config-title" style="display:none">影月博客</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="http://www.shadowmon.com"></a>
    <div title="播放/暂停" class="iconfont icon-play"></div>
    <h3 class="subtitle">ES6中Promise的使用</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">ES6中Promise的使用</h1>
        <div class="stuff">
            <span>五月 27, 2022</span>
            

        </div>
        <div class="content markdown">
            <h1 id="Promise"><a href="#Promise" class="headerlink" title="Promise"></a>Promise</h1><p>在 JavaScript 的世界中，所有代码都是单线程执行的。为了使程序不阻塞执行有了异步（I&#x2F;O操作、事件操作），但是异步也有其不好之处，例如：异步回调callback 回调地狱的问题，伴随着这些问题有了解决方案 Promise。</p>
<h2 id="Callback-方式书写"><a href="#Callback-方式书写" class="headerlink" title="Callback 方式书写"></a>Callback 方式书写</h2><p>回调函数方式书写，如果异步请求多了，将会很难维护，程序看着很乱，也很容易导致回调地狱。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ajax = <span class="keyword">function</span>(<span class="params">callback</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;执行&#x27;</span>);</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    callback &amp;&amp; <span class="title function_">callback</span>()</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">ajax</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;执行 ajax方法&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="Promise-方式书写"><a href="#Promise-方式书写" class="headerlink" title="Promise 方式书写"></a>Promise 方式书写</h2><p>Promise 标准-状态变化（Pending —— Fulfilled&#x2F;Rejected），then 函数不明文指定返回实例，返回本身的 Promise 实例，否则返回指定的 Promise 实例。</p>
<ul>
<li><strong>resove</strong>：执行下一步操作</li>
<li><strong>reject</strong>：中断当前操作</li>
<li><strong>then</strong>：是 <code>Promise</code> 返回的对象，执行下一个，如果有两个函数，第一个表示成功 <code>resolved</code>，第二个表示失败 <code>rejected</code>。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ajax = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;promise&#x27;</span>,<span class="string">&#x27;执行&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve,reject</span>)&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;,<span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">ajax</span>().<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;promise&#x27;</span>,<span class="string">&#x27;执行ajax方法&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>执行两个 Promise 的效果</strong></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ajax = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;promise&#x27;</span>,<span class="string">&#x27;执行&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve,reject</span>)&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;,<span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title function_">ajax</span>()</span><br><span class="line">  .<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve,reject</span>)&#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title function_">resolve</span>();</span><br><span class="line">      &#125;,<span class="number">1000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;promise3&#x27;</span>,<span class="string">&#x27;执行3&#x27;</span>);</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>多个 Promise 实例实现串行操作</strong></li>
</ul>
<p>执行 a b c d 如果中间出了错误使用 catch 来捕获</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ajax = <span class="keyword">function</span>(<span class="params">num</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;执行4&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve,reject</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (num &gt; <span class="number">5</span>) &#123;</span><br><span class="line">      <span class="title function_">resolve</span>();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;出错了&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">ajax</span>(<span class="number">6</span>).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;log&#x27;</span>,<span class="string">&#x27;6&#x27;</span>);</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="keyword">function</span>(<span class="params">err</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;catch&#x27;</span>,err);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="title function_">ajax</span>(<span class="number">3</span>).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;log&#x27;</span>,<span class="string">&#x27;3&#x27;</span>);</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="keyword">function</span>(<span class="params">err</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;catch&#x27;</span>,<span class="string">&#x27;err&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// 执行4</span></span><br><span class="line"><span class="comment">// 执行4</span></span><br><span class="line"><span class="comment">// log 6</span></span><br><span class="line"><span class="comment">// catch err</span></span><br></pre></td></tr></table></figure>

<h2 id="finally"><a href="#finally" class="headerlink" title="finally"></a>finally</h2><p>Promise 执行结束后无论结果是 fulfilled 或 rejected 都会触发 finally 指定的回调函数。避免了同样的代码在 then()、catch() 重复书写。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;success&#x27;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;then: &#x27;</span>, result)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(result);</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;catch: &#x27;</span>, err);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(err);</span><br><span class="line">&#125;).<span class="title function_">finally</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;finally: &#x27;</span>, result);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// then:  success</span></span><br><span class="line"><span class="comment">// finally:  undefined</span></span><br><span class="line"><span class="comment">// Promise &#123;&lt;resolved&gt;: &quot;success&quot;&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Promise-all-并行执行"><a href="#Promise-all-并行执行" class="headerlink" title="Promise.all() 并行执行"></a>Promise.all() 并行执行</h2><p><strong>Promise.all</strong> 以数组的形式接收多个 Promise 实例，内部好比一个 for 循环同步的执行传入的多个 Promise 实例，一旦其中某个 Promise 实例发生 reject 就会触发 Promise.all() 的 catch() 函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有图片加载完在添加到页面上</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loadImg</span>(<span class="params">src</span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> img = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;img&#x27;</span>);</span><br><span class="line">    img.<span class="property">src</span> = src;</span><br><span class="line">    img.<span class="property">onload</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>(img);</span><br><span class="line">    &#125;</span><br><span class="line">    img.<span class="property">onerror</span> = <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">reject</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showImgs</span>(<span class="params">imgs</span>)&#123;</span><br><span class="line">  imgs.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">img</span>)&#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(img)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">  <span class="title function_">loadImg</span>(<span class="string">&#x27;http://www.qzfweb.com/uploads/20170512190539489.jpeg&#x27;</span>),</span><br><span class="line">  <span class="title function_">loadImg</span>(<span class="string">&#x27;http://www.qzfweb.com/uploads/20170225143135972.jpg&#x27;</span>),</span><br><span class="line">  <span class="title function_">loadImg</span>(<span class="string">&#x27;http://www.qzfweb.com/uploads/20170217225453679.jpg&#x27;</span>)</span><br><span class="line">]).<span class="title function_">then</span>(showImgs)</span><br></pre></td></tr></table></figure>

<h2 id="Promise-race-率先执行"><a href="#Promise-race-率先执行" class="headerlink" title="Promise.race() 率先执行"></a>Promise.race() 率先执行</h2><p><strong>Promise.race()</strong> 只要其中一个 Promise 实例率先发生改变，<code>Promise.race()</code> 实例也将发生改变，其他的将不在响应。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 有一个图片加载完就添加到页面上</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loadImg</span>(<span class="params">src</span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> img = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;img&#x27;</span>);</span><br><span class="line">    img.<span class="property">src</span> = src;</span><br><span class="line">    img.<span class="property">onload</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>(img);</span><br><span class="line">    &#125;</span><br><span class="line">    img.<span class="property">onerror</span> = <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">reject</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showImgs</span>(<span class="params">img</span>)&#123;</span><br><span class="line">  <span class="keyword">let</span> p = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;p&#x27;</span>);</span><br><span class="line">  p.<span class="title function_">appendChild</span>(img);</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">race</span>([</span><br><span class="line">  <span class="title function_">loadImg</span>(<span class="string">&#x27;http://www.qzfweb.com/uploads/20170512190539489.jpeg&#x27;</span>),</span><br><span class="line">  <span class="title function_">loadImg</span>(<span class="string">&#x27;http://www.qzfweb.com/uploads/20170225143135972.jpg&#x27;</span>),</span><br><span class="line">  <span class="title function_">loadImg</span>(<span class="string">&#x27;http://www.qzfweb.com/uploads/20170217225453679.jpg&#x27;</span>)</span><br><span class="line">]).<span class="title function_">then</span>(showImgs)</span><br></pre></td></tr></table></figure>

<h2 id="错误捕获"><a href="#错误捕获" class="headerlink" title="错误捕获"></a>错误捕获</h2><p>Promise 实例提供了两种错误捕获的方式，一种是 Promise.then() 方法的第二个参数，另一种是 Promise 实例的 catch() 函数。</p>
<h3 id="then-第二参数捕获错误"><a href="#then-第二参数捕获错误" class="headerlink" title=".then 第二参数捕获错误"></a><strong>.then 第二参数捕获错误</strong></h3><p><code>.then()</code> 第二个回调参数捕获错误具有就近的原则，不会影响后续 then 的进行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ajax = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;promise开始执行&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve,reject</span>)&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="title function_">reject</span>(<span class="string">`There&#x27;s a mistake`</span>);</span><br><span class="line">    &#125;,<span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">ajax</span>()</span><br><span class="line">  .<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;then1&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>();</span><br><span class="line">  &#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;then1里面捕获的err: &#x27;</span>, err);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;then2&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">`There&#x27;s a then mistake`</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;catch里面捕获的err: &#x27;</span>, err);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="comment">// promise开始执行</span></span><br><span class="line"><span class="comment">// then1里面捕获的err:  There&#x27;s a mistake</span></span><br><span class="line"><span class="comment">// then2</span></span><br><span class="line"><span class="comment">// catch里面捕获的err:  There&#x27;s a then mistake</span></span><br></pre></td></tr></table></figure>

<h3 id="catch-捕获错误"><a href="#catch-捕获错误" class="headerlink" title="catch() 捕获错误"></a><strong>catch() 捕获错误</strong></h3><p>Promise 抛错具有冒泡机制，能够不断传递，可以使用 catch() 统一处理，下面代码中不会输出 then1、then2，直接执行 catch() 处理错误。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ajax = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;promise开始执行&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve,reject</span>)&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="title function_">reject</span>(<span class="string">`There&#x27;s a mistake`</span>);</span><br><span class="line">    &#125;,<span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">ajax</span>()</span><br><span class="line">  .<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;then1&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>();</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;then2&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">`There&#x27;s a then mistake`</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;catch里面捕获的err: &#x27;</span>, err);</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="comment">// promise开始执行</span></span><br><span class="line"><span class="comment">// catch里面捕获的err:  There&#x27;s a mistake</span></span><br></pre></td></tr></table></figure>

<p>不论是 Promise 还是 async&#x2F;await 在写法上解决了异步回调 Callback 的问题，但是任何写法都不会改变 JavaScript 单线程、异步的本质，除非 JavaScript 执行引擎发生变化。</p>
<h2 id="手写-Promise-代码"><a href="#手写-Promise-代码" class="headerlink" title="手写 Promise 代码"></a>手写 Promise 代码</h2><p>这是一个经典的面试问题了，我将它放了最后，理清了 Promise 的实现原理，很多问题自然就迎刃而解了，不废话直接上代码，共分为 5 部份完成，实现思路如下：</p>
<ol>
<li>声明 MayJunPromise 类</li>
<li>Then 方法</li>
<li>Promise 解决过程</li>
<li>验证你的 Promise 是否正确</li>
<li>catch、resolve、reject、all、race 方法实现</li>
<li>并发请求控制</li>
</ol>
<h3 id="1-声明-MayJunPromise-类"><a href="#1-声明-MayJunPromise-类" class="headerlink" title="1. 声明 MayJunPromise 类"></a>1. 声明 MayJunPromise 类</h3><p>主要在构造函数里做一些初始化操作</p>
<ul>
<li>行 {1} 初始化一些默认值，Promise 的状态、成功时的 value、失败时的原因</li>
<li>行 {2} onResolvedCallbacks 用于一些异步处理 const p &#x3D; new Promise(resolve &#x3D;&gt; { setTimeout(function(){ resolve(1) }, 5000) })，当 resolve 在 setTimeout 里时，我们调用 p.then() 此时的状态为 pending，因此我们需要一个地方来保存，此处就是用于保存 Promise resolve 时的回调函数集合</li>
<li>行 {3} onRejectedCallbacks 与行 {2} 同理，保存 Promise reject 回调函数集合</li>
<li>行 {4} 成功时回调，先进行状态判断是不可逆的，如果 status &#x3D; pending 修改状态和成功时的 value</li>
<li>行 {5} 失败时回调，与上面行 {4} 同理，例如 resolve(1); reject(‘err’); 第二个 reject 就无法覆盖</li>
<li>行 {6} 自执行</li>
<li>行 {7} 运行失败错误捕获</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装一个自己的 Promise</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MayJunPromise</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">    <span class="comment">// &#123;1&#125; 初始化一些默认值</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> = <span class="string">&#x27;pending&#x27;</span>; <span class="comment">// 一个 promise 有且只有一个状态 (pending | fulfilled | rejected)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">value</span> = <span class="literal">undefined</span>; <span class="comment">// 一个 JavaScript 合法值（包括 undefined，thenable，promise）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reason</span> = <span class="literal">undefined</span>; <span class="comment">// 是一个表明 promise 失败的原因的值</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">onResolvedCallbacks</span> = []; <span class="comment">// &#123;2&#125;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">onRejectedCallbacks</span> = []; <span class="comment">// &#123;3&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#123;4&#125; 成功回调</span></span><br><span class="line">    <span class="keyword">let</span> <span class="title function_">resolve</span> = value =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="string">&#x27;pending&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">status</span> = <span class="string">&#x27;fulfilled&#x27;</span>; <span class="comment">// 终态</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">value</span> = value; <span class="comment">// 终值</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onResolvedCallbacks</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">itemFn</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">itemFn</span>()</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#123;5&#125; 失败回调</span></span><br><span class="line">    <span class="keyword">let</span> <span class="title function_">reject</span> = reason =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="string">&#x27;pending&#x27;</span>) &#123; <span class="comment">// 状态不可逆，例如 resolve(1);reject(&#x27;err&#x27;); 第二个 reject 就无法覆盖</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">status</span> = <span class="string">&#x27;rejected&#x27;</span>; <span class="comment">// 终态</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">reason</span> = reason; <span class="comment">// 终值</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onRejectedCallbacks</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">itemFn</span> =&gt;</span> <span class="title function_">itemFn</span>());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// &#123;6&#125; 自执行</span></span><br><span class="line">      <span class="title function_">fn</span>(resolve, reject);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">      <span class="title function_">reject</span>(err); <span class="comment">// &#123;7&#125; 失败时捕获</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-Then-方法"><a href="#2-Then-方法" class="headerlink" title="2. Then 方法"></a>2. Then 方法</h3><ul>
<li>一个 promise 必须提供一个 then 方法以访问其当前值、终值和据因</li>
<li>行 {8} onFulfilled、onRejected 这两个参数可选，由于 Promise .then 是可以链式调用的，对于值穿透的场景要做判断，如果不传，则返回一个函数，也就是将上个结果进行传递</li>
<li>行 {9} then 方法必须返回一个 promise 对象</li>
<li>行 {10}、{11} 、{12} 也是 then 方法内实现的三种情况，相类似，次数只拿状态等于 fulfilled 进行说明</li>
<li>行 {10.1}  Promise&#x2F;A+ 规范定义：要确保 onFulfilled、onRejected 在下一轮事件循环中被调用，你可以使用 setTimeout 来实现，因为我这里是在 Node.js 环境下，因此推荐使用了 setImmediate 来注册事件（因为可以避免掉 setTimeout 的延迟）</li>
<li>行  {10.2} Promise&#x2F;A+ 标准规定：如果 onFulfilled 或 onRejected 返回的是一个 x，那么它会以 [[Resolve]](promise2, x) 处理解析，我们定义解析的函数 resolveMayJunPromise，也是一个核心函数，下面进行讲解<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装一个自己的 Promise</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MayJunPromise</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 一个 promise 必须提供一个 then 方法以访问其当前值、终值和据因</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type"> Function </span>&#125; onFulfilled 可选，如果是一个函数一定是在状态为 fulfilled 后调用，并接受一个参数 value</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type"> Function </span>&#125; onRejected 可选，如果是一个函数一定是在状态为 rejected 后调用，并接受一个参数 reason</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> &#123;<span class="type"> Promise </span>&#125; 返回值必须为 Promise</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">then</span>(<span class="params">onFulfilled, onRejected</span>) &#123;</span><br><span class="line">    <span class="comment">// &#123;8&#125; 值穿透，把 then 的默认值向后传递，因为标准规定 onFulfilled、onRejected 是可选参数</span></span><br><span class="line">    <span class="comment">// 场景：new Promise(resolve =&gt; resolve(1)).then().then(value =&gt; console.log(value));</span></span><br><span class="line">    onFulfilled = <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(onFulfilled) === <span class="string">&#x27;[object Function]&#x27;</span> ? onFulfilled : <span class="keyword">function</span>(<span class="params">value</span>) &#123;<span class="keyword">return</span> value&#125;;</span><br><span class="line">    onRejected = <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(onRejected) === <span class="string">&#x27;[object Function]&#x27;</span> ? onRejected : <span class="keyword">function</span>(<span class="params">reason</span>) &#123;<span class="keyword">throw</span> reason&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#123;9&#125; then 方法必须返回一个 promise 对象</span></span><br><span class="line">    <span class="keyword">const</span> promise2 = <span class="keyword">new</span> <span class="title class_">MayJunPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// &#123;10&#125;</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="string">&#x27;fulfilled&#x27;</span>) &#123; <span class="comment">// 这里的 this 会继承外层上下文绑定的 this</span></span><br><span class="line">        <span class="comment">// &#123;10.1&#125; Promise/A+ 规定：确保 onFulfilled、onRejected 在下一轮事件循环中被调用</span></span><br><span class="line">        <span class="comment">// 可以使用宏任务 (setTimeout、setImmediate) 或微任务（MutationObsever、process.nextTick）</span></span><br><span class="line">        <span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// &#123;10.2&#125; Promise/A+ 标准规定：如果 onFulfilled 或 onRejected 返回的是一个 x，那么它会以 [[Resolve]](promise2, x) 处理解析</span></span><br><span class="line">            <span class="keyword">const</span> x = <span class="title function_">onFulfilled</span>(<span class="variable language_">this</span>.<span class="property">value</span>);</span><br><span class="line">            <span class="comment">// 这里定义解析 x 的函数为 resolveMayJunPromise</span></span><br><span class="line">            <span class="title function_">resolveMayJunPromise</span>(promise2, x, resolve, reject);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(e);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">      <span class="comment">// &#123;11&#125;</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="string">&#x27;rejected&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> x = <span class="title function_">onRejected</span>(<span class="variable language_">this</span>.<span class="property">reason</span>)</span><br><span class="line">            <span class="title function_">resolveMayJunPromise</span>(promise2, x, resolve, reject);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(e);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// &#123;12&#125;</span></span><br><span class="line">      <span class="comment">// 有些情况无法及时获取到状态，初始值仍是 pending，例如：</span></span><br><span class="line">      <span class="comment">// return new Promise(resolve =&gt; &#123; setTimeout(function() &#123; resolve(1) &#125;, 5000) &#125;)</span></span><br><span class="line">      <span class="comment">//	.then(result =&gt; &#123; console.log(result) &#125;)</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="string">&#x27;pending&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onResolvedCallbacks</span>.<span class="title function_">push</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">const</span> x = <span class="title function_">onFulfilled</span>(<span class="variable language_">this</span>.<span class="property">value</span>);</span><br><span class="line">              <span class="title function_">resolveMayJunPromise</span>(promise2, x, resolve, reject);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">              <span class="title function_">reject</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">  </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onRejectedCallbacks</span>.<span class="title function_">push</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">const</span> x = <span class="title function_">onRejected</span>(<span class="variable language_">this</span>.<span class="property">reason</span>)</span><br><span class="line">              <span class="title function_">resolveMayJunPromise</span>(promise2, x, resolve, reject);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">              <span class="title function_">reject</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> promise2;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="3-Promise-解决过程"><a href="#3-Promise-解决过程" class="headerlink" title="3. Promise 解决过程"></a>3. Promise 解决过程</h3><p>声明函数 resolveMayJunPromise()，<strong>Promise 解决过程</strong>是一个抽象的操作，在这里可以做到与系统的 Promise 或一些遵循 Promise&#x2F;A+ 规范的 Promise 实现相互交互，以下代码建议跟随 Promise&#x2F;A+ 规范进行阅读，规范上面也写的很清楚。<br /><br><br />注意：在实际编码测试过程中规范 [2.3.2] 样写还是有点问题，你要根据其它的 Promise 的状态值进行判断，此处注释掉了，建议使用  [2.3.3] 也是可以兼容的 。<br /></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Promise 解决过程</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type"> Promise </span>&#125; promise2 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type"> any </span>&#125; x </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type"> Function </span>&#125; resolve </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type"> Function </span>&#125; reject </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resolveMayJunPromise</span>(<span class="params">promise2, x, resolve, reject</span>)&#123;</span><br><span class="line">  <span class="comment">// [2.3.1] promise 和 x 不能指向同一对象，以 TypeError 为据因拒绝执行 promise，例如：</span></span><br><span class="line">  <span class="comment">// let p = new MayJunPromise(resolve =&gt; resolve(1))</span></span><br><span class="line">  <span class="comment">// let p2 = p.then(() =&gt; p2); // 如果不做判断，这样将会陷入死循环</span></span><br><span class="line">  <span class="keyword">if</span> (promise2 === x) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise&#x27;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// [2.3.2] 判断 x 是一个 Promise 实例，可以能使来自系统的 Promise 实例，要兼容，例如：</span></span><br><span class="line">  <span class="comment">// new MayJunPromise(resolve =&gt; resolve(1))</span></span><br><span class="line">  <span class="comment">//		.then(() =&gt; new Promise( resolve =&gt; resolve(2)))</span></span><br><span class="line">  <span class="comment">// 这一块发现也无需，因为 [2.3.3] 已经包含了</span></span><br><span class="line">  <span class="comment">// if (x instanceof Promise) &#123;</span></span><br><span class="line">  <span class="comment">// 	// [2.3.2.1] 如果 x 是 pending 状态，那么保留它（递归执行这个 resolveMayJunPromise 处理程序）</span></span><br><span class="line">  <span class="comment">// 	// 直到 pending 状态转为 fulfilled 或 rejected 状态</span></span><br><span class="line">  <span class="comment">// 	if (x.status === &#x27;pending&#x27;) &#123;</span></span><br><span class="line">  <span class="comment">// 		x.then(y =&gt; &#123;</span></span><br><span class="line">  <span class="comment">// 			resolveMayJunPromise(promise2, y, resolve, reject);</span></span><br><span class="line">  <span class="comment">// 		&#125;, reject)</span></span><br><span class="line">  <span class="comment">// 	&#125; else if (x.status === &#x27;fulfilled&#x27;) &#123; // [2.3.2.2] 如果 x 处于执行态，resolve 它</span></span><br><span class="line">  <span class="comment">// 		x.then(resolve); </span></span><br><span class="line">  <span class="comment">// 	&#125; else if (x.status === &#x27;rejected&#x27;) &#123; // [2.3.2.3] 如果 x 处于拒绝态，reject 它</span></span><br><span class="line">  <span class="comment">// 		x.then(reject);</span></span><br><span class="line">  <span class="comment">// 	&#125;</span></span><br><span class="line">  <span class="comment">// 	return;</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// [2.3.3] x 为对象或函数，这里可以兼容系统的 Promise</span></span><br><span class="line">  <span class="comment">// new MayJunPromise(resolve =&gt; resolve(1))</span></span><br><span class="line">  <span class="comment">//		.then(() =&gt; new Promise( resolve =&gt; resolve(2)))</span></span><br><span class="line">  <span class="keyword">if</span> (x != <span class="literal">null</span> &amp;&amp; (x <span class="keyword">instanceof</span> <span class="title class_">Promise</span> || <span class="keyword">typeof</span> x === <span class="string">&#x27;object&#x27;</span> || <span class="keyword">typeof</span> x === <span class="string">&#x27;function&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">let</span> called = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// [2.3.3.1] 把 x.then 赋值给 then</span></span><br><span class="line">      <span class="comment">// 存储了一个指向 x.then 的引用，以避免多次访问 x.then 属性，这种预防措施确保了该属性的一致性，因为其值可能在检索调用时被改变。</span></span><br><span class="line">      <span class="keyword">const</span> then = x.<span class="property">then</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// [2.3.3.3] 如果 then 是函数（默认为是一个 promise），将 x 作为函数的作用域 this 调用之。</span></span><br><span class="line">      <span class="comment">// 传递两个回调函数作为参数，第一个参数叫做 resolvePromise (成功回调) ，第二个参数叫做 rejectPromise（失败回调）</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// then.call(x, resolvePromise, rejectPromise) 等价于 x.then(resolvePromise, rejectPromise)，笔者理解此时会调用到 x 即 MayJunPromise 我们自己封装的 then 方法上</span></span><br><span class="line">        then.<span class="title function_">call</span>(x, <span class="function"><span class="params">y</span> =&gt;</span> &#123; <span class="comment">// [2.3.3.3.1] 如果 resolvePromise 以值 y 为参数被调用，则运行 [[Resolve]](promise, y)</span></span><br><span class="line">            <span class="keyword">if</span> (called) <span class="keyword">return</span>;</span><br><span class="line">            called = <span class="literal">true</span>;</span><br><span class="line">            <span class="title function_">resolveMayJunPromise</span>(promise2, y, resolve, reject);</span><br><span class="line">        &#125;, <span class="function"><span class="params">e</span> =&gt;</span> &#123; <span class="comment">// [2.3.3.3.2] 如果 rejectPromise 以据因 r 为参数被调用，则以据因 r 拒绝 promise</span></span><br><span class="line">          <span class="keyword">if</span> (called) <span class="keyword">return</span>;</span><br><span class="line">          called = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">          <span class="title function_">reject</span>(e);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// [2.3.3.4 ] 如果 then 不是函数，以 x 为参数执行 promise</span></span><br><span class="line">        <span class="title function_">resolve</span>(x)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123; <span class="comment">// [2.3.3.2] 如果取 x.then 的值时抛出错误 e ，则以 e 为据因拒绝 promise</span></span><br><span class="line">      <span class="keyword">if</span> (called) <span class="keyword">return</span>;</span><br><span class="line">      called = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">      <span class="title function_">reject</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">resolve</span>(x);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-验证你的-Promise-是否正确"><a href="#4-验证你的-Promise-是否正确" class="headerlink" title="4. 验证你的 Promise 是否正确"></a>4. 验证你的 Promise 是否正确</h3><p>Promise 提供了一个测试脚本，进行正确性验证。<br /></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i -g promises-aplus-tests</span><br><span class="line">promises-aplus-tests mayjun-promise.<span class="property">js</span></span><br></pre></td></tr></table></figure>

<p><br />同时需要暴露出一个 deferred 方法。<br /></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">MayJunPromise</span>.<span class="property">defer</span> = <span class="title class_">MayJunPromise</span>.<span class="property">deferred</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> dfd = &#123;&#125;</span><br><span class="line">  dfd.<span class="property">promise</span> = <span class="keyword">new</span> <span class="title class_">MayJunPromise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    dfd.<span class="property">resolve</span> = resolve;</span><br><span class="line">    dfd.<span class="property">reject</span> = reject;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> dfd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">MayJunPromise</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-catch、resolve、reject、all、race-方法实现"><a href="#5-catch、resolve、reject、all、race-方法实现" class="headerlink" title="5. catch、resolve、reject、all、race 方法实现"></a>5. catch、resolve、reject、all、race 方法实现</h3><p>Promise&#x2F;A+ 规范中只提供了 then 方法，但是我们使用的 catch、Promise.all、Promise.race 等都可以在 then 方法的基础上进行实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MayJunPromise</span> &#123;</span><br><span class="line">   <span class="title function_">constructor</span>(<span class="params">fn</span>)&#123;...&#125;</span><br><span class="line">  <span class="title function_">then</span>(<span class="params"></span>)&#123;...&#125;,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 捕获错误</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type"> Function </span>&#125; onRejected </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">catch</span>(onRejected) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">then</span>(<span class="literal">undefined</span>, onRejected);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 仅返回成功态，即 status = fulfilled</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">MayJunPromise</span>.<span class="property">resolve</span> = <span class="keyword">function</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (value <span class="keyword">instanceof</span> <span class="title class_">Promise</span> || value <span class="keyword">instanceof</span> <span class="title class_">MayJunPromise</span>) ? value <span class="comment">// 如果是 Promise 实例直接返回</span></span><br><span class="line">    : <span class="keyword">new</span> <span class="title class_">MayJunPromise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="title function_">resolve</span>(value));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 仅返回失败态，即 status = rejected</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">MayJunPromise</span>.<span class="property">reject</span> = <span class="keyword">function</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (value <span class="keyword">instanceof</span> <span class="title class_">Promise</span> || value <span class="keyword">instanceof</span> <span class="title class_">MayJunPromise</span>) ? value : <span class="keyword">new</span> <span class="title class_">MayJunPromise</span>(<span class="function"><span class="params">reject</span> =&gt;</span> <span class="title function_">reject</span>(value));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MayJunPromise.all() 并行执行</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type"> Array </span>&#125; <span class="variable">arr</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type"> Array </span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">MayJunPromise</span>.<span class="property">all</span> = <span class="keyword">function</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MayJunPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> length = arr.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">let</span> results = []; <span class="comment">// 保存执行结果</span></span><br><span class="line">    <span class="keyword">let</span> count = <span class="number">0</span>; <span class="comment">// 计数器</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;length; i++) &#123;</span><br><span class="line">      <span class="title class_">MayJunPromise</span>.<span class="title function_">resolve</span>(arr[i]).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        results[i] = res;</span><br><span class="line">        count++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count === length) &#123; <span class="comment">// 全部都变为 fulfilled 之后结束</span></span><br><span class="line">          <span class="title function_">resolve</span>(results);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="function"><span class="params">err</span> =&gt;</span> <span class="title function_">reject</span>(err)); <span class="comment">// 只要有一个失败，就将失败结果返回</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MayJunPromise.race() 率先执行，只要一个执行完毕就返回结果;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">MayJunPromise</span>.<span class="property">race</span> = <span class="keyword">function</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MayJunPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;arr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="title class_">MayJunPromise</span>.<span class="title function_">resolve</span>(arr[i])</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> <span class="title function_">resolve</span>(result), <span class="function"><span class="params">err</span> =&gt;</span> <span class="title function_">reject</span>(err));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-并发请求控制"><a href="#6-并发请求控制" class="headerlink" title="6. 并发请求控制"></a>6. 并发请求控制</h3><p>Promise.all 同时将请求发出，假设我现在有上万条请求，势必会造成服务器的压力，如果我想限制在最大并发 100 该怎么做？例如，在 Chrome 浏览器中就有这样的限制，Chrome 中每次最大并发链接为 6 个，其余的链接需要等待其中任一个完成，才能得到执行，下面定义 allByLimit 方法实现类似功能。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 并发请求限制</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type"> Array </span>&#125; arr 并发请求的数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type"> Number </span>&#125; limit 并发限制数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">MayJunPromise</span>.<span class="property">allByLimit</span> = <span class="keyword">function</span>(<span class="params">arr, limit</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> length = arr.<span class="property">length</span>;</span><br><span class="line">  <span class="keyword">const</span> requestQueue = [];</span><br><span class="line">  <span class="keyword">const</span> results = [];</span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MayJunPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> requestHandler = <span class="keyword">function</span>(<span class="params"></span>) &#123;	</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Request start &#x27;</span>, index);</span><br><span class="line">      <span class="keyword">const</span> request = arr[index]().<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error&#x27;</span>, err);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">      &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Number of concurrent requests&#x27;</span>, requestQueue.<span class="property">length</span>)</span><br><span class="line">        <span class="keyword">const</span> count = results.<span class="title function_">push</span>(res); <span class="comment">// 保存所有的结果</span></span><br><span class="line"></span><br><span class="line">        requestQueue.<span class="title function_">shift</span>(); <span class="comment">// 每完成一个就从请求队列里剔除一个</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count === length) &#123; <span class="comment">// 所有请求结束，返回结果</span></span><br><span class="line">          <span class="title function_">resolve</span>(results);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (count &lt; length &amp;&amp; index &lt; length - <span class="number">1</span>) &#123;</span><br><span class="line">          ++index;</span><br><span class="line">          <span class="title function_">requestHandler</span>(); <span class="comment">// 继续下一个请求</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (requestQueue.<span class="title function_">push</span>(request) &lt; limit) &#123;</span><br><span class="line">        ++index;</span><br><span class="line">        <span class="title function_">requestHandler</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">requestHandler</span>()</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试，定义一个 sleep 睡眠函数，模拟延迟执行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 睡眠函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type"> Number </span>&#125; ms 延迟时间|毫秒</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type"> Boolean </span>&#125; flag 默认 false，若为 true 返回 reject 测试失败情况</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">sleep</span> = (<span class="params">ms=<span class="number">0</span>, flag=<span class="literal">false</span></span>) =&gt; <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">    <span class="title function_">reject</span>(<span class="string">&#x27;Reject &#x27;</span> + ms);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">resolve</span>(ms);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, ms));</span><br><span class="line"></span><br><span class="line"><span class="title class_">MayJunPromise</span>.<span class="title function_">allByLimit</span>([</span><br><span class="line">  <span class="function">() =&gt;</span> <span class="title function_">sleep</span>(<span class="number">5000</span>, <span class="literal">true</span>),</span><br><span class="line">  <span class="function">() =&gt;</span> <span class="title function_">sleep</span>(<span class="number">1000</span>),</span><br><span class="line">  <span class="function">() =&gt;</span> <span class="title function_">sleep</span>(<span class="number">1000</span>),</span><br><span class="line">  <span class="function">() =&gt;</span> <span class="title function_">sleep</span>(<span class="number">4000</span>),</span><br><span class="line">  <span class="function">() =&gt;</span> <span class="title function_">sleep</span>(<span class="number">10000</span>),</span><br><span class="line">], <span class="number">3</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下为运行结果</span></span><br><span class="line"><span class="title class_">Request</span> start  <span class="number">0</span></span><br><span class="line"><span class="title class_">Request</span> start  <span class="number">1</span></span><br><span class="line"><span class="title class_">Request</span> start  <span class="number">2</span></span><br><span class="line"><span class="title class_">Number</span> <span class="keyword">of</span> concurrent requests <span class="number">3</span></span><br><span class="line"><span class="title class_">Request</span> start  <span class="number">3</span></span><br><span class="line"><span class="title class_">Number</span> <span class="keyword">of</span> concurrent requests <span class="number">3</span></span><br><span class="line"><span class="title class_">Request</span> start  <span class="number">4</span></span><br><span class="line"><span class="title class_">Error</span> <span class="title class_">Reject</span> <span class="number">5000</span></span><br><span class="line"><span class="title class_">Number</span> <span class="keyword">of</span> concurrent requests <span class="number">3</span></span><br><span class="line"><span class="title class_">Number</span> <span class="keyword">of</span> concurrent requests <span class="number">2</span></span><br><span class="line"><span class="title class_">Number</span> <span class="keyword">of</span> concurrent requests <span class="number">1</span></span><br><span class="line">[ <span class="number">1000</span>, <span class="number">1000</span>, <span class="string">&#x27;Reject 5000&#x27;</span>, <span class="number">4000</span>, <span class="number">10000</span> ]</span><br></pre></td></tr></table></figure>

<h3 id="7-Promise-reference"><a href="#7-Promise-reference" class="headerlink" title="7. Promise reference"></a>7. Promise reference</h3><ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/21834559">https://zhuanlan.zhihu.com/p/21834559</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5b2f02cd5188252b937548ab">https://juejin.im/post/5b2f02cd5188252b937548ab</a></li>
<li><a target="_blank" rel="noopener" href="https://promisesaplus.com/">https://promisesaplus.com/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ituring.com.cn/article/66566">https://www.ituring.com.cn/article/66566</a></li>
</ul>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        
                            <li title="0" data-url="http://link.hhtjim.com/163/425570952.mp3"></li>
                        
                    
                        
                            <li title="1" data-url="http://link.hhtjim.com/163/425570952.mp3"></li>
                        
                    
                </ul>
            
        </div>
        
    <div id="gitalk-container" class="comment link"
		data-enable="false"
        data-ae="false"
        data-ci=""
        data-cs=""
        data-r=""
        data-o=""
        data-a=""
        data-d="false"
    >查看评论</div>


    </div>
    
</div>


    </div>
</div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false,"tagMode":false});</script></body>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/click-love.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



  
  

      

  
  
  <div id="aplayer-hjnObCgk" class="aplayer aplayer-tag-marker meting-tag-marker" data-id="5415564598"
       data-server="netease" data-type="playlist" data-loop="none"
       data-order="random" data-lrctype="0" data-listfolded="true" 
       data-fixed="true" data-autoplay="true" 
       data-volume="0.4" data-mutex="true" 
       data-listmaxheight="400px" data-preload="none" 
       data-theme="">
  </div>
  





</html>
